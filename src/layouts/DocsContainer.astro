---
import { getCollection, type CollectionEntry } from "astro:content";

const allDocs = await getCollection("docs");

// Group docs by category
type GroupedDocs = Record<string, CollectionEntry<"docs">[]>;

const groupedDocs = allDocs.reduce(
    (acc: GroupedDocs, doc: CollectionEntry<"docs">) => {
        const category = doc.data.category;
        if (!acc[category]) acc[category] = [];
        acc[category].push(doc);
        return acc;
    },
    {} as GroupedDocs,
);

// Sort each group by order
Object.keys(groupedDocs).forEach((category: string) => {
    groupedDocs[category].sort(
        (a: CollectionEntry<"docs">, b: CollectionEntry<"docs">) =>
            a.data.order - b.data.order,
    );
});

// Pre-process categories
type CategoryInfo = {
    category: string;
    docs: CollectionEntry<"docs">[];
};

const categoriesWithDocs: CategoryInfo[] = Object.entries(groupedDocs).map(
    ([category, docs]) => ({
        category,
        docs,
    }),
);

type Props = {
    currentSlug: string;
};

const { currentSlug } = Astro.props;
---

<div class="docs-container pt-navDouble">
    <aside class="sidebar">
        <nav>
            {
                categoriesWithDocs.map(({ category, docs }) => (
                    <div class="category-group" data-category={category}>
                        <button
                            class="category-header"
                            data-category-toggle={category}
                        >
                            <h3 class="category-title ">{category}</h3>
                            <svg
                                class="chevron"
                                width="16"
                                height="16"
                                viewBox="0 0 16 16"
                                fill="none"
                            >
                                <path
                                    d="M4 6L8 10L12 6"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                />
                            </svg>
                        </button>
                        <ul
                            class="category-content"
                            data-category-content={category}
                        >
                            <div class="category-content-wrapper">
                                {docs.map((doc) => {
                                    const docSlug = doc.data.slug || doc.slug;
                                    return (
                                        <li>
                                            <a
                                                href={`/docs/${docSlug}`}
                                                class:list={[
                                                    "doc-link",
                                                    {
                                                        active:
                                                            currentSlug ===
                                                            docSlug,
                                                    },
                                                ]}
                                            >
                                                {doc.data.title}
                                            </a>
                                        </li>
                                    );
                                })}
                            </div>
                        </ul>
                    </div>
                ))
            }
        </nav>
    </aside>

    <main class="content">
        <slot />
    </main>
</div>

<script>
    // Toggle categories
    document.addEventListener("DOMContentLoaded", () => {
        const toggleButtons = document.querySelectorAll(
            "[data-category-toggle]",
        );

        toggleButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const category = button.getAttribute("data-category-toggle");
                const categoryGroup = button.closest(".category-group");
                const content = categoryGroup?.querySelector(
                    `[data-category-content="${category}"]`,
                );

                if (categoryGroup && content) {
                    categoryGroup.classList.toggle("collapsed");
                }
            });
        });
    });
</script>
